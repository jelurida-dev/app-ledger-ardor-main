name: Compilation & tests

on: [push, pull_request]

jobs:
  job_build_debug:
    name: Build debug
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/ledgerhq/ledger-app-builder/ledger-app-builder:latest

    steps:
      - name: Clone
        uses: actions/checkout@v2

      - name: Build
        run: make DEBUG=1

      - name: Upload app binary
        uses: actions/upload-artifact@v2
        with:
          name: app-bin
          path: bin

  job_unit_test:
    name: Unit test
    needs: job_build_debug
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/ledgerhq/ledger-app-builder/ledger-app-builder:latest

    steps:
      - name: Clone
        uses: actions/checkout@v2

      - name: Build and run unit tests
        run: |
          cd tests
          cmake -Bbuild -H. && make -C build && make -C build test

  job_clang_scan_build:
    name: Clang scan-build
    needs: job_build_debug
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/ledgerhq/ledger-app-builder/ledger-app-builder:latest

    steps:
      - name: Clone
        uses: actions/checkout@v2
      
      - name: Run static analyzer
        run: |
          make clean
          scan-build --use-cc=clang -analyze-headers -enable-checker security -enable-checker unix -enable-checker valist -o scan-build --status-bugs make default
  
  job_functional_test:
    name: Functional test
    needs: job_build_debug
    runs-on: ubuntu-latest

    container:
      image: ghcr.io/ledgerhq/speculos:latest
      options: --entrypoint /bin/bash
    
    steps:
      - name: Install dependencies
        run: apt update && apt install -qy openjdk-11-jdk-headless git

      - name: Download app binary
        uses: actions/download-artifact@v2
        with:
          name: app-bin
          path: /tmp/app

      - name: Run speculos in the background
        run: |
          /speculos/speculos.py --display headless --seed "opinion change copy struggle town cigar input kit school patient execute bird bundle option canvas defense hover poverty skill donkey pottery infant sense orchard" /tmp/app/app.elf 2>/tmp/speculos.log &
          echo $! >/tmp/speculos.pid

# The ardor-ledger-test repository is a temporary solution until the next version is made public with the Speculos driver
      - name: Install and compile Ardor
        run: |
          git clone https://sargue@bitbucket.org/sargue/ardor-ledger-test.git /ardor
          cd /ardor
          ./compile.sh --skip-desktop

      - name: Run tests
        run: |
          cd /ardor
          ./run-unit-tests.sh com.jelurida.ardor.integration.wallet.ledger.application.ArdorAppBridgeHeadlessTest

      - name: Kill speculos
        run: kill -9 $(cat /tmp/speculos.pid)

      - name: Upload Speculos log
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: speculos-log
          path: /tmp/speculos.log

      - name: Upload Ardor log
        uses: actions/upload-artifact@v2
        if: failure()
        with:
          name: ardor-log
          path: /ardor/logs/ardor.0.log
